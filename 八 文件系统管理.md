# 八 文件系统管理

## 回顾分区和文件系统

### 分区类型
- 主分区：总共最多只能分4个
- 扩展分区：
    - 只能有1个，也算作主分区的一种，主分区+扩展分区最多只有4个
    - 扩展分区不能存储数据和格式化，需要划分为逻辑分区才能使用
- 逻辑分区：
    - 逻辑分区是在扩展分区中划分的
    - IDE硬盘linux最多支持59个逻辑分区
    - SCSI硬盘linux最多支持11个逻辑分区

### 分区设备文件名
分区|分区设备文件名
--|--
主分区1|/dev/sda1
主分区2|/dev/sda2
主分区3|/dev/sda3
扩展分区|/dev/sda4
逻辑分区1|/dev/sda5
逻辑分区2|/dev/sda6

**常见分法**：

分区|分区设备文件名
--|--
主分区1|/dev/sda1
扩展分区|/dev/sda2
逻辑分区1|/dev/sda5
逻辑分区2|/dev/sda6

### 文件系统
- ext2
    - 是ext文件系统的升级版本，Red Hat Linux7.2版本以前的默认文件系统
    - 1993年发布，最大支持16TB的分区和2TB的文件`1TB=1024GB=1024*1024MB`
- ext3
    - 与ext2最大区别在于带有日志功能，在系统突然停止时提高文件系统可靠性
    - 最大支持16TB分区和2TB文件
- ext4
    - 进步非常大，最大支持1EB分区和16TB文件，无限数量子目录，Extents连续数据块概念，多块分配，延迟分配，持久预分配，快速FSCK，日志校验，无日志模式，在线碎片整理，inode增强，默认启用barrier等
    - `1EB=1024PB=1024*1024TB`
    - centOS7默认文件系统

## 文件系统常用命令

### `df`,`du`,`fsck`,`dump2fs`命令

#### 统计文件系统的占用情况`df`
```
df 选项 挂载点
    -a  显示所有文件系统信息，包括一些隐藏的特殊分区
    -h  人性化显示（最常用）
    -T  显示文件系统类型
```

#### 统计目录和文件大小`du`
文件可以用`ls`查看，而目录大小就用`du`
```
du 选项 目录或文件名
    -h  人性化显示
    -s  统计总占用量，不显示子目录
    -a  显示子文件的磁盘占用量，默认只显示子目录的占用量
    
常用：du -sh 目录
```
- 此命令会扫描磁盘文件，负载较高，避免高峰期使用
- `df`和`du`的区别
    - `du`只计算文件和目录占用的空间
    - `df`从文件系统考虑占用的空间，包括文件和目录本身，命令和系统本身占用的空间，例如：**文件已经删除但程序还未释放的空间**
    - 所以通常`df`看到的大小会比`du`大一些，但如果差距很大，可能需要考虑采取措施释放磁盘空间，例如重启
    - `df`看到的磁盘空间才是真正的磁盘占用和剩余空间
- linux需要定期重启，例如一些高负载的服务器(软件，热门网页，游戏)，需要每周重启一次，负载较低的服务器也至少每个月重启一次
- linux很稳定，即使连续运行1~2年，也能稳定运行，但可能会有很多磁盘空间没有释放，影响部分性能

#### 文件系统修复命令`fsck`
```
fsck 选项 分区设备文件名
     -a 不用显示用户提示，自动修复文件系统
     -y 自动修复，和-a功能一致，不过有些文件系统只支持-y
```
- 开机会自动执行，通常不需要手工执行

#### 显示磁盘状态命令`dumpe2fs`
`dumpe2fs 分区设备文件名`
```
输出很长，通常会用
dumpe2fs -h 分区设备文件名
         -h 仅显示超级块中信息，而不显示磁盘块组的详细信息

要查看组信息也常用more或者grep查看特定组
用more查看
dumpe2fs 分区设备文件名 | more
用grep查看
dumpe2fs 分区设备文件名 | grep 匹配信息
```
- 常用来查看分区中一个数据块是多大，以及分区功能，如ACL权限

### 挂载命令

#### 查询与自动挂载
- `mount -l`查询系统中已经挂载的设备，`-l`会显示卷标名称
- `mount -a`依据配置文件`/etc/fstab`的内容，自动挂载

#### 挂载命令格式
```
mount 选项 设备文件名 挂载点
        -t 文件系统：加入文件系统类型来指定挂载类型,
        可以ext3\ext4\iso9660\vfat等文件系统，其中，
        vfat就是fat32等fat文件系统
        -L 卷标名：挂载指定卷标的分区，而不是安装设
        备文件名挂载，可以不用写
        -o 特殊选项：可以指定挂载的额外选项
    特殊选项：
        -o remount  重新挂载
        -o exec     允许分区中可执行文件执行

mount -o remount,noexec /home/  不允许/home下的文件执行，
即使是root也无法执行，文件服务器可以
设置用户上传的分区内程序无法执行，有效保护分区安全
```

### 挂载光盘与U盘

#### 挂载光盘
- 建立挂载点`mkdir /mnt/cdrom/`
- 把光盘放入光驱
- 挂载光盘`mount -t iso9660 /dev/sr0 /mnt/cdrom`
    - 或`mount /dev/cdrom /mnt/cdrom`
- 卸载光盘
    - 退出光盘目录
    - `umount 设备文件名或挂载点`

#### 挂载U盘
- 查看U盘设备文件名`fdisk -l`
- `mount -t vfat /dev/sdb1 `
    - FAT16 = fat
    - FAT32 = vfat
- 卸载U盘
    - `umunt /dev/sdb1`

注意：linux默认是不支持NTFS文件系统的

### 支持NTFS文件系统
linux系统内核没有对NTFS文件系统的驱动支持，解决办法有两个思路：
1. 内核编译（可以去了解一下，是比较底层的技术）
2. 安装第三方插件，如：`NTFS-3G`

- 挂载命令：`mount -t ntfs-3g 分区设备名 挂载点`
- 卸载命令：`umount 分区设备名`

## `fdisk`分区

### fdisk分区过程

#### 用fdisk工具分区
- 添加新硬盘
- 查询新硬盘`fdisk -l`
- 使用`fdisk`命令分区`fdisk /dev/sdb`

命令|功能
----|----
d|删除一个分区
l|显示已知的文件系统类型，82为linux swap分区，83为linux分区
m|显示帮助菜单
n|新建分区
p|显示分区列表
q|不保存退出
t|改变一个分区的系统ID
w|保存退出

- 保存退出
    - 如果保存时提示分区表正在被使用，需要重启linux，可以使用`partprobe`来重新读取分区表信息
    - 养成良好习惯，保存分区后都重新读取一下分区表信息
- 格式化分区
    - `mkfs -t ext4 /dev/sdb1`
- 建立挂载点并挂载
    - `mkdir /disk1`
    - `mount /dev/sdb1 /disk1/`
- 用`mount`或`df`命令查看分区是否挂载成功
#### 手动挂载后，重启会失效，所以需要设置自动挂载

### 分区自动挂载与fstab文件修复

#### 分区自动挂载
**重要系统文件，谨慎修改，以免无法开机**
```
UUID=4b499d76-769a-40a0-93dc-4a31a59add28   /   ext4  noatime,acl,user_xattr 1 1
```
- 文件格式
    - 第一字段：分区设备文件名或UUID（硬盘通用唯一识别码）,可以用`dumpe2fs -h 设备文件名`查看
    - 第二字段：挂载点
    - 第三字段：文件系统名称
    - 第四字段：挂载参数，权限
    - 第五字段：指定分区是否被dump备份，0表示不备份，1表示每天备份，2表示不定期备份，备份目录`lost+found`
    - 第六字段：指定分区是否被fsck检测，0表示不检测，其他数字代表检测的优先级，1最高，根分区之外通常设置2
- 使用自动挂载命令`mount -a`测试文件是否修改成功

#### `/etc/fstab`文件修复
- 万一开机报错，可以输入root密码进入命令行
- 用`mount -o remount,rw /`重新挂载根分区，添加读写权限
- 再去修改`/etc/fstab`