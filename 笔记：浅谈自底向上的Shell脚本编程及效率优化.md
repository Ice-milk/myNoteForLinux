# 资料笔记：shell效率优化

《浅谈自底向上的Shell脚本编程及效率优化》
作者：沐星晨
2011年03月25日 10:17:00
https://blog.csdn.net/sosodream/article/details/6276758

**摘要**：低效的shell脚本设计会进一步影响原本解释器模式下并不见长的程序运行效率，使其在面对大数据量文本分析时的资源与时间消耗变成难以接受的。本文分析了shell语言及其应用需求的特点，从分层设计的角度提出了“自底向上进行shell脚本编程”的理论，同时提出了从“外部系统环境”到“内部执行模式”全面的掌握工具软件的方法。实例充分证明，自底向上的shell脚本编程思想及方法能够有效提高脚本的执行效率。

**关键词**：脚本; 正则；管道

## 自底向上

​		自底向上设计方法是根据系统功能要求，从已有的模块开始，对其进行相互连接、修改和扩大，构成所要求的系统。该方法是从底层（已有模块或库）开始的，实际中无论是取用已有模块还是自行设计程序，其设计成本和开发周期都优于自顶向下法；但由于设计是从最底层开始的，所以难以保证总体设计的最佳性，例如程序结构不优化、能够共用的程序段没有共用。

>   拓展：自顶向下
>
>   将大型程序设计分割成大小不一的小模块来实现特定的功能，最后通过由顶层模块调用子模块来实现整体功能，这就是Top-Down的设计思想。

基于shell脚本的“自底向上”的编程风格，可以从工具软件的挑选和应用方向考虑优化程序效率。而工具软件的挑选与应用，离不开以下二点：

a:系统原理知识的了解及应用

b:工具软件的执行模式的了解及应用

系统是工具软件的外部条件和应用环境，执行模式是软件的内部环境，只有由里到外对工具软件进行全面的了解，才能够结合实际需求和设计，提高脚本执行效率。

## 数值计算

需求：计算1到100000累加结果

方法1：采用bash  shell的数值计算

```shell
time for((i=0;i<=100000;i++)); do ((sum+=i)); done ; echo $sum
real    0m1.134s
user    0m1.080s
sys     0m0.048s
5000050000
```

方法2：采用awk的数值计算

```shell
time awk 'BEGIN{while(i++<100000)sum+=i; printf "%d", sum;}'
5000050000
real    0m0.029s
user    0m0.020s
sys     0m0.000s
```

实例结果分析：同等的累加运算，采用*shell*的数值计算耗时*1.134*秒，采用*awk*工具只需要*0.029*秒。实验结果表明，适当的采用工具软件，能够明显提高*shell*脚本的执行效率。

## 系统原理应用

### 文件系统

需求：计算定长大数据量文件的总记录数

方法1：采用wc命令，在文件遍历过程中累计文件记录数。

方法2：采用ls命令，读取索引中的文件大小信息，除以单条记录长度即可获得总记录数。

实例结果分析：方法2的效率在于充分利用了文件系统和需求，减少了文件I/O和遍历计算。在大文件处处理中的效率提高程序尤为明显。

### 正则

​		正则是文本匹配的利器，被广泛应用于字符串匹配之中，而字符串匹配往往是进行文本增加、删除、修改、查询等操作的基础前提。从效率上考虑，尽管正则使用起来十分方便，但出于效率考虑，正则却未必是最好的选择。实际的shell脚本开发中需要了解各种工具所支持的正则标准和正则匹配脚本运行中占用的时间比，在开发过程中结合实际需求，考虑是否需要采用正则，然后再考虑采用哪种工具哪种正则标准。

需求：某文本以空格和/进行分隔，获取第五列的内容.        

方法1：采用正则[ /]分别匹配二种分隔符，取得第五列

```shell
time awk -F'[ /]' '{print $5}' a.txt  >/dev/null
real    0m17.717s
user    0m14.749s
sys     0m2.844s
```

方法2：实际数据分析中发现，可以采用单字符解析的方式，首先根据“空格”分隔符取得第4列，再利用“/”分隔符取得第二列。

```shell
time awk '{print $4}' a.txt |awk -F/ '{print $2}' >/dev/null
real    0m0.565s
user    0m0.224s
sys     0m0.688s
```

实例结果分析：awk采用-F指定分隔符，在多分隔符情况下，会启用正则去解析记录，增加了函数调用，和字符串匹配的消耗，效率上理所当然的比不上默认的空格或单字符分隔符采用的简单的字符比较方式，尽管如此，方法2依赖于对需求的进一步分析，适用的需求范围没有使用正则那么简便灵活。

### 软件执行模式

#### sed执行模式及效率优化

​		sed是一个POSIX.2标准支持的流编辑程序。sed在执行过程中利用了二个可以操作的空间：模式空间和缓冲空间，和一个可控制的操作循环（cycle)。 sed的执行模式的便是基于这样一个循环操作：读入一行文本进入模式空间并执行操作，直到输入结束或主动退出。

​		sed的魅力便在于利用这二个空间和操作循环所进行的运算及由此产生的强大功能，这种强大充分体现在sed运算的图灵完备性：单个sed命令可以模拟所有图灵运算。简单的说，单个sed命令可以实现任何的运算任务。尽管如此，限于sed的执行模式和效率考虑，一般情况下却不将sed 用于文本操作外的计算比如数学运算等，sed通常应用于文本的查询，替换，过滤等操作。

​		了解了sed的执行模式，我们就可以通过控制sed的循环，采用合理的程序逻辑以提高命令执行效率。

实例：sed应用，读取指定行

方法1：`sed -n '45,50p' filename`

方法2：`sed -n '51q;45,50p' filename`

实例结果分析：方法2在方法1基础上增加了一个判断，当文件读取到第51行时即时退出。避免文件后续部分的遍历，在大数据量处理上能够很大的提高执行效率。

实例：sed应用，文本替换

方法1：`sed 's/foo/bar/g' filename`

方法2：`sed '/foo/ s/foo/bar/g' filename`

实例结果分析：sed支持采用正则进行匹配和替换，考虑字符串替换的需求中，不防加上地址以提高速度。实例中通过增加一个判断逻辑，采用“事先匹配”代替“直接替换”，由于sed会保留前一次的正则匹配环境，不会产生冗余的正则匹配，因此方法2具有比方法1更高的效率

#### awk执行模式及效率优化

​		awk不只是一个应用工具，还是一种语法和程序结构类似于C语言的高级编程语言,可以用来开发包括数学运算，字符串处理等运算功能完善的awk脚本程序。awk的执行模式也是基于这样一个循环：先从输入中获取一条记录，然后根据pattern真假决定是否执行action，pattern是对数值运算或文本匹配结果的逻辑判断，action即是由awk的编程语言定义支持的各种操作程序，awk支持用正则用以进行字符串匹配操作。

​		awk的效率体现在其类似于C语言的高效的主体程序结。awk采用了yacc的yyparse对awk脚本进行解析并形成node结点树，再由采用了c语言编写并且编译完成的awk主体程序树进行递归遍历。这种执行方式，使得awk既有解释程序的便捷，又有编译程序的效率。

​		awk的特色数据结构：哈希数组，也称关联数组。哈希数组中的每个单元包括二个元素：单元键（key)及单元值（values)。哈希结构的效益体现在以较小的内存空间实现大的数据空间上的数据存放，节省了数据占存空间；同时哈希数组中的数据访问是随机访问，不需要遍历而直接通过哈希函数直接访问数组单元取值，节省了数据查询时间。

需求：分析apace日志，获取访问量较大的前十个IP地址

方法：` awk ‘{ips[$1]++;}END{for(ip in ips)print ip,ips[ip]}’ |sort –nk2|head -10`

实例结果分析：该apace日志首列保存ip信息。能过awk对日志进行一次遍历，即实现了IP信息的获取，同时采用了哈希结构，对ip进行了累计。

## 总结

1.  awk在数值计算方面效率远高于shell自己的计算方法

2.  查找和正则的范围越小越好，可以逐步缩小