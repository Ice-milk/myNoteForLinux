# 六 用户和用户组管理
- 为什么要添加用户？
    - 企业级服务器的管理需要相应的管理团队，各自有所分工，分配不同的用户更**方便团队管理**和查看操作记录
    - 每个用户分配与任务相关的权限，可以防止对任务以外的系统误操作
- 为什么要管理用户？    
    - 要提高服务器安全性能，就需要建立合理的用户权限等级制度和服务器操作规范
- 如何管理用户？
    - 在linux中主要是通过**修改用户配置文件**来查看和修改用户信息
    - 命令只是方便用来shell编程，平时不多用

## 用户配置文件

### 用户信息文件`/etc/passwd`
**！修改前要备份**

文件信息格式：
```
name:password:UID:GID:GECOS:directory:shell
root:x:0:0:root:/root:/bin/bash
```
- `name` 用户名称
- `password` 密码标志
    - `x` 有密码
    - 真正的密码存放在`/etc/shadow`里，并通过一定方式加密了
    - `/etc/shadow`的用户权限为`---------`只用root可以查看，提高了安全性
- `UID` 用户ID
    - `0` 超级用户，
    - `1-499` 系统用户（伪用户）
    - `500-65535` 普通用户
    - 理论上UID唯一，但是可以通过修改UID将两个‘用户’变为一个，例如将普通用户UID改为0，操作系统会将这个用户当做root用户
- `GID` 初始组ID
    - 初始组：用户创建后就可以获得这个组的相关权限，自动分配，每个用户有且仅有一个初始组，一般和用户名相同，不推荐修改
    - 附加组：用户可以参加多个组，共享其他组的权限，所以修改组推荐通过添加附加组的方式
    - 组ID匹配组名称`/etc/group`
- `GECOS` 用户说明
- `directory` 用户家目录
    - 普通用户：`/home/用户名/`
    - root用户：`/root/`
- `shell` 登录过后的shell（linux命令解释器）
    - 在`/etc/passwd`中除了标准shell是`/bin/bash`外，还可以写`/sbin/nologin`，这是一种暂时禁用用户的方法

### 用户影子文件`/etc/shadow`
- 文件权限`000`
```
name:password:date:minage:maxage::::
root:$1$NzdkAyZD$4xtKByjFIIFbp6Ip8Mzgu1%:18100:0:99999:7:::
```
- `name` 用户名
- `password` 密码（加密）
    - 加密方式，可以查阅官方资料
    - 可以破解，所以此文件决不能外传
    - 如果密码为`!!`或`*`表示没有密码，不能登录，也是禁用的一种方式
- `date` 密码最后一次修改日期
    - 设置密码的时间，从1970.1.1开始，每过一天+1
    - 如果设置为`0`，则要求用户登录时必须修改密码
- `minage` 密码的修改的最小间隔，0表示可以随时改
- `maxage` 密码的有效期`90`表示每90天修改一次密码
- 到期前几天提醒修改密码，`7`表示到期前7天提醒修改密码
- 密码到期后的宽限天数，`0/不写`到期立即失效，`-1`永不失效
- 账号失效时间，要用时间戳表示，到时间戳就会失效
- 保留，暂时没有用

```
时间戳换算：
时间戳换算为日期
date -d "1970-01-01 18000 days"
日期换算为时间戳
echo $(($(date --date="2019/7/30" +%s)/86400+1))
```

### 组信息文件`/etc/group`和组密码文件`/etc/gshadow`

#### /etc/group
```
root:x:0:
```
- 组名，默认和用户名一样
- 组密码标志
- 组管理员UID
- 组附加用户UID

#### /etc/gshadow
```
root:::
```
- 组名
- 组密码
- 组管理员UID
- 组中附加用户UID

## 用户管理相关文件

### 家目录
用户初始登录位置
- 普通用户：`/home/用户名`，所有者和所属组都是此用户，权限700
    - 将普通用户，通过改UID的方式变为超级用户后，家目录不变
- root：`/root`，所有者和所属组都是root，权限550

### 用户邮箱
- `/var/spool/mail/用户名`

### 用户模板目录
- `/etc/skel`，每添加新用户，就会把相应文件添加到用户家目录，可以用来添加服务器管理手册

## 用户管理命令

### 用户添加命令`useradd`
`useradd 选项 用户名`
```
选项：
    -u UID      指定用户的UID
    -d 家目录   指定用户家目录(不推荐)
    -c 用户说明 指定用户说明
    -g 组名     指定用户初始组(不推荐)
    -G 组名     指定用户附加组
    -s shell    指定用户登录的shell，默认是`/bin/bash`
```
- 用户默认值文件
```
/etc/default/useradd
    GROUP=100
    HOME=/home
    INACTIVE=-1     密码过期宽限天数
    EXPIRE=         密码失效时间
    SHELL=/bin/bash 默认shell
    SKEL=/etc/skel  模板目录
    CREATE_MAIL_SPOOL=yes   是否建立邮箱
```
```
/etc/login.defs
    PASS_MAX_DAYS 99999 密码有效期
    PASS_MIN_DAYS 0     密码修改间隔
    PASS_MIN_LEN 5      密码最小5位
    PASS_WARN_AGE 7     密码到期警告
    UID_MIN 500         最小和最大UID范围
    GID_MAX 60000
    ENCRYPT_METHOD SHA512   加密方式
```

### 修改用户密码`passwd`
`passwd 选项 用户名`
```
选项：
    -S  查询用户密码和状态，仅root可用
    -l  暂时锁定用户，仅root可用(shadow密码前+!!)
    -u  解锁用户，仅root可用
    --stdin 可以通过管道符输出的数据作为用户的密码
    echo "123" | passwd --stdin user主要用在shell编程中批量操作
```
- 普通用户可以修改自己的密码
- 超级用户可以修复了任何用户的密码，包括自己的
```
passwd -S root
root PS 2019-07-23 0 99999 7 -1 (Password set, MD5 crypt.)
密码最后修改日期 修改间隔 有效期 过期提示 过期延迟失效 (密码加密方式)
```

### 修改用户信息`usermod`密码状态`chage`
- `usermod`的选项和`useradd`类似
```
usermod 选项 用户名
选项：
    -u UID      指定用户的UID
    -c 用户说明 指定用户说明
    -G 组名     指定用户附加组
    -s shell    指定用户登录的shell，默认是`/bin/bash`
    -L          锁定用户
    -U          解锁用户锁定
```
- 修改用户密码状态`chage`
```
chage 选项 用户名
选项：
    -l      列出用户的详细密码状态
    -d 日期 修改密码最后一次修改日期
    -m 天数 两次密码修改间隔
    -M 天数 密码有效期
    -W 天数 密码过期前警告天数
    -I 天数 密码过期后宽限天数
    -E 日期 账号失效时间
```
**直接修改`/etc/shadow`更直观，但是可以用`chage -d 0 用户名`来要求用户登录后必须修改密码

### 删除用户`userdel`切换用户`su`
- 删除用户`userdel`
```
userdel -r 用户名
        -r 删除用户的同时删除用户家目录
```
- 查看用户UID`id`
```
id 用户名
uid=0(root) gid=0(root) groups=0(root)
```
- 切换用户`su`
```
su 选项 用户名
    -   选项只使用-，代表连带用户的环境变量一起替换
    -c 命令 仅执行一次命令，而不切换身份相当于sudo
su - root -c "useradd user1"
```
***特别注意**：直接用`su 用户名`，使用过程会报错，因为`env`没有改变
- 切换回原来的用户可以用`exit`

## 用户组管理命令

### 添加用户组`groupadd`
```
groupadd 选项 组名
         -g GID 指定组ID
```

### 修改用户组`groupmod`
```
groupmod 选项 组名
         -g GID
         -n 新组名
```
通常不用，删了重建更可靠

### 删除用户组`groupdel`
`groupdel 组名`
组中有初始用户，无法删除组

### 把用户添加入组或从组中删除`gpasswd`
```
gpasswd 选项 组名
        -a 用户名   把用户加入组
        -d 用户名   把用户从组中删除
```